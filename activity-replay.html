<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Activity Log Replay - Live Browser</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #0d1117;
        color: #e6edf3;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Header */
      .header {
        padding: 12px 20px;
        background: #161b22;
        border-bottom: 1px solid #30363d;
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
        flex-shrink: 0;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #00d4ff, #0099cc);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }

      .logo-text {
        font-weight: 700;
        font-size: 16px;
        background: linear-gradient(135deg, #00d4ff, #58a6ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .badge {
        background: rgba(0, 212, 255, 0.15);
        color: #00d4ff;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
      }

      .divider {
        width: 1px;
        height: 24px;
        background: #30363d;
      }

      .btn {
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #00d4ff, #0099cc);
        color: #000;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
      }

      .btn-secondary {
        background: #21262d;
        color: #e6edf3;
        border: 1px solid #30363d;
      }

      .btn-secondary:hover {
        background: #30363d;
      }

      #fileInput {
        display: none;
      }

      .file-info {
        font-size: 12px;
        color: #8b949e;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 6px;
        background: #21262d;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #8b949e;
      }

      .status-dot.playing {
        background: #22c55e;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Main content */
      .main {
        flex: 1;
        display: flex;
        overflow: hidden;
        min-height: 0;
      }

      /* Browser area */
      .browser-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        padding: 16px;
        gap: 12px;
      }

      .browser-frame {
        flex: 1;
        background: #161b22;
        border-radius: 12px;
        border: 1px solid #30363d;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      .browser-titlebar {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        background: #21262d;
        border-bottom: 1px solid #30363d;
        gap: 10px;
        flex-shrink: 0;
      }

      .browser-buttons {
        display: flex;
        gap: 6px;
      }

      .browser-button {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .browser-button.red {
        background: #ff5f56;
      }
      .browser-button.yellow {
        background: #ffbd2e;
      }
      .browser-button.green {
        background: #27c93f;
      }

      .browser-url-bar {
        flex: 1;
        background: #0d1117;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 13px;
        color: #8b949e;
        display: flex;
        align-items: center;
        gap: 8px;
        overflow: hidden;
      }

      .browser-url-bar .icon {
        color: #22c55e;
      }
      .browser-url-bar .url-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
      }

      .browser-content {
        flex: 1;
        position: relative;
        background: #fff;
        overflow: hidden;
      }

      .browser-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: #fff;
      }

      .iframe-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 10;
      }

      .click-indicator {
        position: absolute;
        width: 40px;
        height: 40px;
        border: 3px solid #f97316;
        border-radius: 50%;
        background: rgba(249, 115, 22, 0.2);
        transform: translate(-50%, -50%) scale(0);
        pointer-events: none;
        z-index: 100;
      }

      .click-indicator.animate {
        animation: clickRipple 0.6s ease-out forwards;
      }

      @keyframes clickRipple {
        0% {
          transform: translate(-50%, -50%) scale(0);
          opacity: 1;
        }
        50% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.8;
        }
        100% {
          transform: translate(-50%, -50%) scale(1.5);
          opacity: 0;
        }
      }

      /* Scroll indicator */
      .scroll-track {
        position: absolute;
        right: 8px;
        top: 8px;
        bottom: 8px;
        width: 12px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 6px;
        z-index: 20;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .scroll-track.visible {
        opacity: 1;
      }

      .scroll-thumb {
        position: absolute;
        width: 100%;
        background: linear-gradient(180deg, #22c55e, #16a34a);
        border-radius: 6px;
        transition: top 0.3s ease-out, height 0.1s;
        min-height: 30px;
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
      }

      .scroll-percent-badge {
        position: absolute;
        right: 28px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(34, 197, 94, 0.9);
        color: #000;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 700;
        opacity: 0;
        transition: opacity 0.3s;
        white-space: nowrap;
      }

      .scroll-percent-badge.visible {
        opacity: 1;
      }

      /* Viewport indicator - shows where user is looking on page */
      .viewport-indicator {
        position: absolute;
        left: 0;
        right: 20px;
        border: 2px solid rgba(34, 197, 94, 0.5);
        background: rgba(34, 197, 94, 0.05);
        pointer-events: none;
        z-index: 15;
        transition: top 0.3s ease-out, opacity 0.3s;
        opacity: 0;
        border-radius: 4px;
      }

      .viewport-indicator.visible {
        opacity: 1;
      }

      .viewport-label {
        position: absolute;
        top: -24px;
        left: 8px;
        background: rgba(34, 197, 94, 0.9);
        color: #000;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
      }

      .action-toast {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        padding: 12px 24px;
        background: rgba(0, 0, 0, 0.9);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: transform 0.3s ease;
        z-index: 100;
        border: 1px solid #30363d;
      }

      .action-toast.visible {
        transform: translateX(-50%) translateY(0);
      }

      .action-toast.click {
        border-color: #f97316;
        color: #f97316;
      }
      .action-toast.scroll {
        border-color: #22c55e;
        color: #22c55e;
      }
      .action-toast.select {
        border-color: #a855f7;
        color: #a855f7;
      }
      .action-toast.copy {
        border-color: #eab308;
        color: #eab308;
      }
      .action-toast.input {
        border-color: #ec4899;
        color: #ec4899;
      }
      .action-toast.navigate {
        border-color: #58a6ff;
        color: #58a6ff;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #0d1117;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 50;
        transition: opacity 0.3s;
      }

      .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #30363d;
        border-top-color: #00d4ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        color: #8b949e;
        font-size: 14px;
      }

      .error-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #8b949e;
        padding: 40px;
        display: none;
      }

      .error-message.visible {
        display: block;
      }

      .error-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      /* Controls */
      .controls {
        background: #161b22;
        border-radius: 10px;
        border: 1px solid #30363d;
        padding: 12px 16px;
        flex-shrink: 0;
      }

      .timeline-container {
        margin-bottom: 12px;
      }

      .timeline {
        height: 6px;
        background: #21262d;
        border-radius: 3px;
        cursor: pointer;
        position: relative;
        overflow: visible;
      }

      .timeline-progress {
        height: 100%;
        background: linear-gradient(90deg, #00d4ff, #58a6ff);
        border-radius: 3px;
        transition: width 0.1s linear;
        position: relative;
      }

      .timeline-thumb {
        position: absolute;
        right: -6px;
        top: 50%;
        transform: translateY(-50%);
        width: 14px;
        height: 14px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .timeline-events {
        position: absolute;
        top: 10px;
        left: 0;
        right: 0;
        height: 4px;
      }

      .timeline-event-marker {
        position: absolute;
        width: 4px;
        height: 4px;
        background: #58a6ff;
        border-radius: 50%;
        transform: translateX(-50%);
        opacity: 0.6;
      }

      .timeline-event-marker.page {
        background: #58a6ff;
      }
      .timeline-event-marker.click {
        background: #f97316;
      }
      .timeline-event-marker.scroll {
        background: #22c55e;
      }

      .controls-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }

      .time-display {
        font-family: "SF Mono", Monaco, monospace;
        font-size: 12px;
        color: #8b949e;
        min-width: 100px;
      }

      .playback-buttons {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .playback-btn {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 6px;
        background: #21262d;
        color: #e6edf3;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 14px;
      }

      .playback-btn:hover {
        background: #30363d;
      }

      .playback-btn.play {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #00d4ff, #0099cc);
        color: #000;
        font-size: 18px;
      }

      .playback-btn.play:hover {
        transform: scale(1.05);
      }

      .speed-select {
        background: #21262d;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 6px 10px;
        color: #e6edf3;
        font-size: 12px;
        cursor: pointer;
      }

      /* Sidebar */
      .sidebar {
        width: 320px;
        background: #161b22;
        border-left: 1px solid #30363d;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 12px 16px;
        border-bottom: 1px solid #30363d;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .sidebar-title {
        font-weight: 600;
        font-size: 14px;
      }

      .sidebar-count {
        font-size: 11px;
        color: #8b949e;
        background: #21262d;
        padding: 2px 8px;
        border-radius: 10px;
      }

      .events-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
      }

      .event-item {
        padding: 10px 12px;
        border-radius: 6px;
        margin-bottom: 4px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
      }

      .event-item:hover {
        background: #21262d;
      }

      .event-item.active {
        background: rgba(0, 212, 255, 0.1);
        border-color: rgba(0, 212, 255, 0.3);
      }

      .event-item.page {
        border-left: 3px solid #58a6ff;
      }

      .event-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }

      .event-icon {
        font-size: 14px;
      }

      .event-type {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: #8b949e;
      }

      .event-time {
        font-size: 10px;
        color: #6e7681;
        margin-left: auto;
        font-family: monospace;
      }

      .event-detail {
        font-size: 12px;
        color: #e6edf3;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* Empty state */
      .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #8b949e;
        padding: 40px;
      }

      .empty-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.3;
      }

      .empty-text {
        font-size: 18px;
        margin-bottom: 8px;
        color: #e6edf3;
      }

      .empty-subtext {
        font-size: 13px;
        text-align: center;
        line-height: 1.5;
      }

      /* Responsive */
      @media (max-width: 900px) {
        .sidebar {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <div class="logo-icon">üîÑ</div>
        <span class="logo-text">Activity Replay</span>
      </div>
      <span class="badge">LIVE BROWSER</span>

      <div class="divider"></div>

      <input type="file" id="fileInput" accept=".json" />
      <button
        class="btn btn-primary"
        onclick="document.getElementById('fileInput').click()"
      >
        üìÇ Load JSON
      </button>

      <span class="file-info" id="fileInfo">No file loaded</span>

      <div style="flex: 1"></div>

      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Ready</span>
      </div>
    </div>

    <!-- Main content -->
    <div class="main" id="mainContent">
      <!-- Empty state -->
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">üåê</div>
        <div class="empty-text">Load an activity log to replay</div>
        <div class="empty-subtext">
          Click "Load JSON" and select your activity log file.<br />
          The browser will replay your recorded session with real pages.
        </div>
      </div>
    </div>

    <!-- Player UI (hidden until file loaded) -->
    <template id="playerTemplate">
      <div class="browser-area">
        <div class="browser-frame">
          <div class="browser-titlebar">
            <div class="browser-buttons">
              <div class="browser-button red"></div>
              <div class="browser-button yellow"></div>
              <div class="browser-button green"></div>
            </div>
            <div class="browser-url-bar">
              <span class="icon">üîí</span>
              <span class="url-text" id="currentUrl">about:blank</span>
            </div>
          </div>
          <div class="browser-content">
            <iframe
              class="browser-iframe"
              id="browserIframe"
              sandbox="allow-same-origin allow-scripts allow-forms"
            ></iframe>

            <div class="iframe-overlay" id="iframeOverlay">
              <div class="click-indicator" id="clickIndicator"></div>
              <div class="viewport-indicator" id="viewportIndicator">
                <div class="viewport-label">Viewport</div>
              </div>
            </div>

            <div class="scroll-track" id="scrollTrack">
              <div class="scroll-thumb" id="scrollThumb"></div>
              <div class="scroll-percent-badge" id="scrollBadge">0%</div>
            </div>

            <div class="action-toast" id="actionToast">
              <span class="action-icon"></span>
              <span class="action-text"></span>
            </div>

            <div class="loading-overlay" id="loadingOverlay">
              <div class="loading-spinner"></div>
              <div class="loading-text">Loading page...</div>
            </div>

            <div class="error-message" id="errorMessage">
              <div class="error-icon">üö´</div>
              <div>This site cannot be loaded in iframe</div>
              <div style="font-size: 12px; margin-top: 8px; opacity: 0.7">
                Security restrictions prevent embedding
              </div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="timeline-container">
            <div class="timeline" id="timeline">
              <div class="timeline-progress" id="timelineProgress">
                <div class="timeline-thumb"></div>
              </div>
              <div class="timeline-events" id="timelineEvents"></div>
            </div>
          </div>
          <div class="controls-row">
            <div class="time-display">
              <span id="currentTime">0:00</span> /
              <span id="totalTime">0:00</span>
            </div>
            <div class="playback-buttons">
              <button class="playback-btn" onclick="skipTo(0)" title="Restart">
                ‚èÆ
              </button>
              <button
                class="playback-btn"
                onclick="prevEvent()"
                title="Previous"
              >
                ‚è™
              </button>
              <button
                class="playback-btn play"
                id="playBtn"
                onclick="togglePlay()"
              >
                ‚ñ∂
              </button>
              <button class="playback-btn" onclick="nextEvent()" title="Next">
                ‚è©
              </button>
              <button class="playback-btn" onclick="skipToEnd()" title="End">
                ‚è≠
              </button>
            </div>
            <select
              class="speed-select"
              id="speedSelect"
              onchange="changeSpeed()"
            >
              <option value="0.5">0.5x</option>
              <option value="1" selected>1x</option>
              <option value="2">2x</option>
              <option value="4">4x</option>
              <option value="8">8x</option>
            </select>
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="sidebar-header">
          <span class="sidebar-title">Timeline</span>
          <span class="sidebar-count" id="eventCount">0</span>
        </div>
        <div class="events-list" id="eventsList"></div>
      </div>
    </template>

    <script>
      // State
      let events = [];
      let currentIndex = -1;
      let isPlaying = false;
      let playbackSpeed = 1;
      let playInterval = null;
      let startTime = 0;
      let endTime = 0;
      let currentPlayTime = 0;
      let lastLoadedUrl = "";

      // Event types config
      const eventConfig = {
        page_load: {
          icon: "üåê",
          label: "Navigate",
          class: "navigate",
          isPage: true,
        },
        tab_activated: {
          icon: "üìë",
          label: "Tab",
          class: "navigate",
          isPage: true,
        },
        click: { icon: "üëÜ", label: "Click", class: "click" },
        scroll: { icon: "üìú", label: "Scroll", class: "scroll" },
        text_selection: { icon: "‚úÇÔ∏è", label: "Select", class: "select" },
        copy: { icon: "üìã", label: "Copy", class: "copy" },
        paste: { icon: "üì•", label: "Paste", class: "copy" },
        form_input: { icon: "‚å®Ô∏è", label: "Input", class: "input" },
        form_submit: { icon: "üì§", label: "Submit", class: "input" },
        download_click: { icon: "‚¨áÔ∏è", label: "Download", class: "click" },
      };

      // DOM refs (populated after template insert)
      let dom = {};

      // File handler
      document
        .getElementById("fileInput")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          try {
            const text = await file.text();
            const data = JSON.parse(text);

            if (!Array.isArray(data)) throw new Error("Expected array");

            // Sort and filter events
            events = data
              .filter(
                (e) =>
                  eventConfig[e.event_type] &&
                  e.url &&
                  !e.url.startsWith("chrome://")
              )
              .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (events.length === 0) {
              alert("No valid events found in file");
              return;
            }

            document.getElementById(
              "fileInfo"
            ).textContent = `${file.name} (${events.length} events)`;

            // Detect viewport from click coordinates
            detectOriginalViewport(events);

            initPlayer();
          } catch (err) {
            alert("Error: " + err.message);
          }
        });

      function initPlayer() {
        // Insert player template
        const main = document.getElementById("mainContent");
        const template = document.getElementById("playerTemplate");
        main.innerHTML = "";
        main.appendChild(template.content.cloneNode(true));

        // Get DOM refs
        dom = {
          iframe: document.getElementById("browserIframe"),
          urlBar: document.getElementById("currentUrl"),
          overlay: document.getElementById("iframeOverlay"),
          clickIndicator: document.getElementById("clickIndicator"),
          viewportIndicator: document.getElementById("viewportIndicator"),
          scrollTrack: document.getElementById("scrollTrack"),
          scrollThumb: document.getElementById("scrollThumb"),
          scrollBadge: document.getElementById("scrollBadge"),
          toast: document.getElementById("actionToast"),
          loading: document.getElementById("loadingOverlay"),
          error: document.getElementById("errorMessage"),
          timeline: document.getElementById("timeline"),
          progress: document.getElementById("timelineProgress"),
          events: document.getElementById("timelineEvents"),
          currentTime: document.getElementById("currentTime"),
          totalTime: document.getElementById("totalTime"),
          playBtn: document.getElementById("playBtn"),
          eventsList: document.getElementById("eventsList"),
          eventCount: document.getElementById("eventCount"),
          statusDot: document.getElementById("statusDot"),
          statusText: document.getElementById("statusText"),
        };

        // Setup
        startTime = new Date(events[0].timestamp).getTime();
        endTime = new Date(events[events.length - 1].timestamp).getTime();
        currentPlayTime = 0;
        currentIndex = -1;

        dom.totalTime.textContent = formatTime(endTime - startTime);
        dom.eventCount.textContent = events.length;

        // Render timeline markers
        renderTimelineMarkers();

        // Render events list
        renderEventsList();

        // Timeline click
        dom.timeline.addEventListener("click", handleTimelineClick);

        // Iframe load handler
        dom.iframe.addEventListener("load", () => {
          dom.loading.classList.add("hidden");
          dom.error.classList.remove("visible");
        });

        dom.iframe.addEventListener("error", () => {
          dom.loading.classList.add("hidden");
          dom.error.classList.add("visible");
        });

        // Start at first event
        seekToEvent(0);
      }

      function renderTimelineMarkers() {
        dom.events.innerHTML = "";
        const duration = endTime - startTime;

        events.forEach((event, i) => {
          const eventTime = new Date(event.timestamp).getTime() - startTime;
          const pos = (eventTime / duration) * 100;

          const marker = document.createElement("div");
          marker.className = "timeline-event-marker";
          if (eventConfig[event.event_type]?.isPage)
            marker.classList.add("page");
          else if (event.event_type === "click") marker.classList.add("click");
          else if (event.event_type === "scroll")
            marker.classList.add("scroll");
          marker.style.left = `${pos}%`;
          marker.title = `${
            eventConfig[event.event_type]?.label || event.event_type
          }`;
          dom.events.appendChild(marker);
        });
      }

      function renderEventsList() {
        dom.eventsList.innerHTML = "";

        events.forEach((event, i) => {
          const config = eventConfig[event.event_type] || {
            icon: "‚ùì",
            label: event.event_type,
          };
          const time = new Date(event.timestamp);

          let detail = "";
          if (event.url) {
            try {
              const url = new URL(event.url);
              detail = url.hostname;
            } catch {
              detail = event.url.substring(0, 30);
            }
          }
          if (event.data?.title) detail = event.data.title.substring(0, 40);
          if (event.data?.element?.text)
            detail = event.data.element.text.substring(0, 40);
          if (event.data?.text)
            detail = `"${event.data.text.substring(0, 30)}..."`;
          if (event.event_type === "scroll") {
            const dir =
              event.data?.direction === "down"
                ? "‚Üì"
                : event.data?.direction === "up"
                ? "‚Üë"
                : "";
            detail = `${event.data?.scroll_percent || 0}% ${dir} scrolled`;
          }

          const item = document.createElement("div");
          item.className = "event-item" + (config.isPage ? " page" : "");
          item.dataset.index = i;
          item.innerHTML = `
          <div class="event-header">
            <span class="event-icon">${config.icon}</span>
            <span class="event-type">${config.label}</span>
            <span class="event-time">${time.toLocaleTimeString()}</span>
          </div>
          <div class="event-detail">${detail || "‚Äî"}</div>
        `;
          item.onclick = () => seekToEvent(i);
          dom.eventsList.appendChild(item);
        });
      }

      function formatTime(ms) {
        const sec = Math.floor(ms / 1000);
        const min = Math.floor(sec / 60);
        return `${min}:${(sec % 60).toString().padStart(2, "0")}`;
      }

      function togglePlay() {
        isPlaying = !isPlaying;
        dom.playBtn.textContent = isPlaying ? "‚è∏" : "‚ñ∂";
        dom.statusDot.classList.toggle("playing", isPlaying);
        dom.statusText.textContent = isPlaying ? "Playing" : "Paused";

        if (isPlaying) {
          startPlayback();
        } else {
          stopPlayback();
        }
      }

      function startPlayback() {
        stopPlayback();

        playInterval = setInterval(() => {
          currentPlayTime += 100 * playbackSpeed;

          const duration = endTime - startTime;
          if (currentPlayTime >= duration) {
            currentPlayTime = duration;
            togglePlay();
            return;
          }

          updateProgress();
          processEventsUpTo(currentPlayTime);
        }, 100);
      }

      function stopPlayback() {
        if (playInterval) {
          clearInterval(playInterval);
          playInterval = null;
        }
      }

      function updateProgress() {
        const duration = endTime - startTime;
        const pct = (currentPlayTime / duration) * 100;
        dom.progress.style.width = `${pct}%`;
        dom.currentTime.textContent = formatTime(currentPlayTime);
      }

      function processEventsUpTo(time) {
        const targetTime = startTime + time;

        // Find events to process
        while (currentIndex < events.length - 1) {
          const nextEvent = events[currentIndex + 1];
          const nextTime = new Date(nextEvent.timestamp).getTime();

          if (nextTime <= targetTime) {
            currentIndex++;
            executeEvent(events[currentIndex]);
            highlightEvent(currentIndex);
          } else {
            break;
          }
        }
      }

      function executeEvent(event) {
        const config = eventConfig[event.event_type];
        if (!config) return;

        // Build toast message
        let toastText = config.label;
        if (event.data?.title) {
          toastText += `: ${event.data.title.substring(0, 30)}`;
        } else if (event.event_type === "scroll") {
          const dir =
            event.data?.direction === "down"
              ? "‚Üì"
              : event.data?.direction === "up"
              ? "‚Üë"
              : "";
          toastText += `: ${event.data?.scroll_percent || 0}% ${dir}`;
        } else if (event.data?.element?.text) {
          toastText += `: "${event.data.element.text.substring(0, 20)}"`;
        } else if (event.data?.text) {
          toastText += `: "${event.data.text.substring(0, 20)}"`;
        }

        // Show toast
        showToast(config.icon, toastText, config.class);

        // Handle different event types
        switch (event.event_type) {
          case "page_load":
          case "tab_activated":
            if (
              event.url &&
              event.url !== lastLoadedUrl &&
              !event.url.startsWith("chrome://")
            ) {
              loadUrl(event.url);
              lastLoadedUrl = event.url;
            }
            break;

          case "click":
            if (event.data?.x && event.data?.y) {
              showClick(
                event.data.x,
                event.data.y,
                event.data.viewport_width,
                event.data.viewport_height
              );
            }
            break;

          case "scroll":
            showScroll(event.data?.scroll_percent || 0, event.data?.direction);
            break;
        }
      }

      function loadUrl(url) {
        dom.urlBar.textContent = url;
        dom.loading.classList.remove("hidden");
        dom.error.classList.remove("visible");

        // Some sites block iframes - we'll try anyway
        dom.iframe.src = url;

        // Timeout for sites that don't load
        setTimeout(() => {
          if (!dom.loading.classList.contains("hidden")) {
            dom.loading.classList.add("hidden");
          }
        }, 5000);
      }

      // Detect original viewport size from click coordinates
      let originalViewportWidth = 0;
      let originalViewportHeight = 0;

      function detectOriginalViewport(events) {
        let maxX = 0,
          maxY = 0;
        events.forEach((e) => {
          if (e.event_type === "click" && e.data) {
            if (e.data.x > maxX) maxX = e.data.x;
            if (e.data.y > maxY) maxY = e.data.y;
          }
        });
        // Estimate viewport from max click coordinates
        if (maxX > 0) {
          if (maxX < 1300) originalViewportWidth = 1366;
          else if (maxX < 1500) originalViewportWidth = 1536;
          else if (maxX < 1800) originalViewportWidth = 1920;
          else originalViewportWidth = 2560;
        } else originalViewportWidth = 1920;

        if (maxY > 0) {
          if (maxY < 700) originalViewportHeight = 768;
          else if (maxY < 900) originalViewportHeight = 900;
          else if (maxY < 1000) originalViewportHeight = 1080;
          else originalViewportHeight = 1200;
        } else originalViewportHeight = 1080;
      }

      function showClick(x, y, eventViewportW, eventViewportH) {
        const rect = dom.overlay.getBoundingClientRect();

        // Priority: 1) viewport from event, 2) detected, 3) defaults
        const srcWidth = eventViewportW || originalViewportWidth || 1920;
        const srcHeight = eventViewportH || originalViewportHeight || 1080;

        const scaleX = rect.width / srcWidth;
        const scaleY = rect.height / srcHeight;

        const clickX = x * scaleX;
        const clickY = y * scaleY;

        dom.clickIndicator.style.left = `${Math.max(
          20,
          Math.min(clickX, rect.width - 20)
        )}px`;
        dom.clickIndicator.style.top = `${Math.max(
          20,
          Math.min(clickY, rect.height - 20)
        )}px`;
        dom.clickIndicator.classList.remove("animate");
        void dom.clickIndicator.offsetWidth;
        dom.clickIndicator.classList.add("animate");
      }

      let scrollHideTimeout = null;

      function showScroll(percent, direction) {
        const pct = Math.min(100, Math.max(0, percent));

        // Show scroll track
        dom.scrollTrack.classList.add("visible");

        // Update thumb position
        // Thumb represents viewport (assume 30% of page visible at once)
        const thumbHeight = 30; // percentage
        const maxTop = 100 - thumbHeight;
        const thumbTop = (pct / 100) * maxTop;

        dom.scrollThumb.style.height = `${thumbHeight}%`;
        dom.scrollThumb.style.top = `${thumbTop}%`;

        // Update badge
        dom.scrollBadge.textContent = `${Math.round(pct)}% ${
          direction === "down" ? "‚Üì" : direction === "up" ? "‚Üë" : ""
        }`;
        dom.scrollBadge.classList.add("visible");
        dom.scrollBadge.style.top = `${thumbTop + thumbHeight / 2}%`;

        // Show viewport indicator on the page
        const overlayRect = dom.overlay.getBoundingClientRect();
        const viewportHeight = overlayRect.height * 0.4; // 40% of view
        const maxViewportTop = overlayRect.height - viewportHeight;
        const viewportTop = (pct / 100) * maxViewportTop;

        dom.viewportIndicator.style.top = `${viewportTop}px`;
        dom.viewportIndicator.style.height = `${viewportHeight}px`;
        dom.viewportIndicator.classList.add("visible");

        // Hide after delay
        clearTimeout(scrollHideTimeout);
        scrollHideTimeout = setTimeout(() => {
          dom.scrollTrack.classList.remove("visible");
          dom.scrollBadge.classList.remove("visible");
          dom.viewportIndicator.classList.remove("visible");
        }, 2000);
      }

      function showToast(icon, text, className) {
        dom.toast.innerHTML = `<span>${icon}</span><span>${text}</span>`;
        dom.toast.className = `action-toast ${className} visible`;

        setTimeout(() => {
          dom.toast.classList.remove("visible");
        }, 2000);
      }

      function highlightEvent(index) {
        document.querySelectorAll(".event-item").forEach((el, i) => {
          el.classList.toggle("active", i === index);
        });

        const active = dom.eventsList.querySelector(".event-item.active");
        if (active) {
          active.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }
      }

      function seekToEvent(index) {
        if (index < 0 || index >= events.length) return;

        const event = events[index];
        currentPlayTime = new Date(event.timestamp).getTime() - startTime;
        currentIndex = index - 1; // So processEventsUpTo will process this event

        updateProgress();
        processEventsUpTo(currentPlayTime);
      }

      function prevEvent() {
        if (currentIndex > 0) seekToEvent(currentIndex - 1);
      }

      function nextEvent() {
        if (currentIndex < events.length - 1) seekToEvent(currentIndex + 1);
      }

      function skipTo(time) {
        currentPlayTime = time;
        currentIndex = -1;
        lastLoadedUrl = "";
        updateProgress();
        processEventsUpTo(currentPlayTime);
      }

      function skipToEnd() {
        skipTo(endTime - startTime);
      }

      function changeSpeed() {
        playbackSpeed = parseFloat(
          document.getElementById("speedSelect").value
        );
      }

      function handleTimelineClick(e) {
        const rect = dom.timeline.getBoundingClientRect();
        const pct = (e.clientX - rect.left) / rect.width;
        const duration = endTime - startTime;
        skipTo(pct * duration);
      }

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (!events.length) return;

        if (e.code === "Space") {
          e.preventDefault();
          togglePlay();
        } else if (e.code === "ArrowLeft") {
          prevEvent();
        } else if (e.code === "ArrowRight") {
          nextEvent();
        }
      });
    </script>
  </body>
</html>
